---
title: "STAT 545A - Homework 3: Use dplyr/ggplot2 to manipulate and explore data"
author: Glenn McGuinness
output: 
    html_document:
        toc: true
        keep_md: true
        css: two_columns.css
---

## Introduction

This assignment is intended to provide a deep dive into manipulating data using dplyr and visualizing the results using ggplot2. It is intended to be a more thorough version of assignment 2, demonstrating a practical knowledge of shaping and displaying data.

```{r import, echo = FALSE}
library(gapminder)
library(tidyverse)
```

## Tasks

This section will explore the different tasks according to the parameters of the assignment. This was described in the [assignment](http://stat545.com/Classroom/assignments/hw03/hw03.html) as follows:

> Pick at least three of the tasks below (in the “Task menu” section) and attack each with a table and figure. For each table, make sure to include a relevant figure! Note that:
>
> dplyr should be your data manipulation tool
> ggplot2 should be your visualization tool
> Make observations about what your tables/figures show and about the process.
> 
> Also useful for you to add to your “cheat sheet” are notes on difficulties/oddities. For example, which figures are easy/hard to make, which data formats make better inputs for plotting functions vs. for human-friendly tables.

Each of the following subsections will tackle one task.

### How is life expectancy changing over time on different continents?

This is an interesting intial question. It is an easy approach to analyze the data and suggest future avenues of exploration. The continents will likely be a proxy for other factors, which can be explored once the initial exploration is complete.

First, I will comment on the process used to generate the figures. The inline table/plot was done using a css file posted by Jenny Bryan and authored by Omar AlOmeir at this [gist](https://gist.github.com/jennybc/e9e9aba6ba18c72cec26#file-2015-03-02_plot-next-to-table-rmd). The bars on the line plot are the 25% and 75% quantiles of life expectancy by continent. The table was generated by using the spread function from `tidyr`, which is part of the tidyverse package. I wished to have continents for the rows and years for the columns, to make it easier to read. I used this function, though it is not in `dplyr`, because it provides an elegant way of performing a common task, and thus greatly improves readability. 

```{r continentlifeExpTable}
lifeExpByContinent = gapminder %>%
  group_by(continent, year) %>%
  summarize(median = median(lifeExp),
            '25%' = quantile(lifeExp, prob = 0.25),
            '75%' = quantile(lifeExp, prob = 0.55))

# I learned how to use select to reshape my data from this article:
# https://datacarpentry.org/R-ecology-lesson/03-dplyr.html#reshaping_with_gather_and_spread
lifeExpByContinentPretty = lifeExpByContinent %>%
  select(continent, year, median) %>%
  spread(key = year, value = median)

lifeExpByContinentTable = lifeExpByContinentPretty %>%
  knitr::kable(digits = 2)

```

```{r continentlifeExpPlot}
lifeExpByContinentPlot = lifeExpByContinent %>%
  ggplot(aes(x = year, group = continent, colour = continent)) +
  geom_line(aes(y = median)) +
  geom_errorbar(aes(ymin = `25%`, ymax = `75%`)) +
  theme_bw()
```

<div class="twoC">
```{r lifeExpGraphics = 'asis', echo = FALSE}
# Note that echo is set to false to prevent the code from being put in the same column as the table or plot
lifeExpByContinentTable
lifeExpByContinentPlot
```
</div>
<div class="clearer"></div>

A few features can be clearly seen in the above plot. The first is that life expectancy has been rising, with a few exceptions, in every continent or the entire period observed. One of the exceptions is Africa in 2002. The continent with the lowest life expectancy is Africa, and the continent with the highest life expectancy is Oceania. It is not surprising that Oceania has such high life expectancy, as it has only `r gapminder %>% filter(continent == "Oceania", year == 2007) %>% count()` countries, both of which are wealthy. The rise in Africa's life expectancy appears to have levelled off, while the other continents appear to trend upwards. 

The median life expectancies, of each continent maintain their relative order over all of the years, although Asia makes significant gains on the Americas. The continent, from highest to lowest median life expectancy, are Oceania, Europe, Americas, Asia, and Africa.

### Report the absolute and/or relative abundance of countries with low life expectancy over time by continent

This section will explore the number of countries below the median world population by continent over time. The median is being used to avoid being overly affected by outliers in the dataset.

Calculating the median and the life expectancy relative to the median is easy, but not all of the manipulations are trivial. I wanted to keep all of the rows in the initial data frame, so I could make my desired plot. However, I needed to keep one row per continent per year for my desired table. To accomplish this, I used mutate to make `lifeExpGreaterThanAmount` and then filtered to keep the first row in each year per continent for `lifeExpGreaterThanAmountPretty`. I learned how to do this in the following [Stack Overflow Post](https://stackoverflow.com/questions/31528981/select-first-and-last-row-from-grouped-data). Notice that all of the columns I kept for the latter data frame are the same for each year in each continent.

I chose the following plot, as I wished to give a sense of the scale of points below the world median while also displaying the numbers. To this end, I decided to plot the points, coloured by whether they were above the world median by year, labelled with the number of points that are above the line, and facetted by continent.

I also did a stacked bar plot to show the fraction of countries in each continent below the world median life expectancy. I did this to provide an alternative visualization of scale. It is a bit simpler, but provides a reasonable represeantation of scale.

```{r lifeExpGreaterThanAmount}
lifeExpGreaterThanAmount = gapminder %>%
  group_by(year) %>%
  mutate(worldMedian = median(lifeExp)) %>%
  group_by(continent, year) %>%
  mutate(lessThanMedian = lifeExp < worldMedian, 
         numberLifeExpectanciesLessThanMedian = sum(lessThanMedian),
         numberOfCountries = n())

# I learned how to use select to reshape my data from this article:
# https://datacarpentry.org/R-ecology-lesson/03-dplyr.html#reshaping_with_gather_and_spread
lifeExpGreaterThanAmountPretty = lifeExpGreaterThanAmount %>%
  select(continent, year, numberLifeExpectanciesLessThanMedian) %>%
  group_by(continent, year) %>%
  filter(row_number() == 1) %>%
  spread(key = year, value = numberLifeExpectanciesLessThanMedian)

lifeExpGreaterThanAmountTable = lifeExpGreaterThanAmountPretty %>%
  knitr::kable()
```

```{r lifeExpGreaterThanAmountPlot}
lifeExpGreaterThanAmountPlot = lifeExpGreaterThanAmount %>%
  ggplot(aes(year)) +
  geom_point(aes(y = lifeExp, colour = lessThanMedian), alpha = 0.1) +
  geom_line(aes(y = worldMedian)) +
  geom_text(aes(y = worldMedian, label = numberLifeExpectanciesLessThanMedian), vjust = 1.5) +
  facet_wrap(~continent) +
  theme_bw()

lifeExpGreaterThanAmountBarPlot = lifeExpGreaterThanAmount %>%
  ggplot(aes(year)) +
  geom_bar(aes(fill = lessThanMedian), alpha = 0.8) +
  facet_wrap(~continent) +
  theme_bw()
```


```{r lifeExpGreaterThanAmountGraphics1, fig.width=10, echo = FALSE}
lifeExpGreaterThanAmountPlot
```

<div class="twoC">
```{r lifeExpGreaterThanAmountGraphics2 = 'asis', fig.width=10, echo = FALSE}
lifeExpGreaterThanAmountTable
lifeExpGreaterThanAmountBarPlot
```
</div>
<div class="clearer"></div>

From these results, it is clear that the relative number of countries below the world median life expectancy in a continent is mostly consistent over time. The only significant trend is that there is a small decrease in the number of countries in Asia below the world median life expectancy and a slight increase in the Americas. This is likely due to the narrowing of gap in the median life expectancy between Asia and the Americas that was observed in the previous section.

We can also see that African countries are mostly below the world median life expectancy. Asian countries are more evenly distributed on either side of the median. The Americas are mostly, but not entirely, above the median. Finally, Europe and Oceania are almost entirely above the median.

### Find countries with interesting stories

For this section, I will need to find countries with interesting stories. I think that interesting stories tend to have the most volatility, so I will be looking at countries with the greatest amount of volatility in gdp per capita. It is hard to get a sense of the volatility with such low resolution data in the presence of trends. To control the effect of overall regional growth, I will normalize the results by continent.

```{r volatileGdpPerCapita}
# This is a bit complex, but I first calculate the gdpPerCap by region each year, normalize each country.
# I then calculate the variance of the gdpPerCap for each country over time, and then filter to get
# the ten countries with the highest variance of gdpPercap.
volatileGdpPerCapita = gapminder %>%
  group_by(year, continent) %>%
  mutate(regionalMedGPC = median(gdpPercap),
         normGPC = gdpPercap / regionalMedGPC,) %>%
  group_by(continent, country) %>%
  mutate(varNormGPC = var(normGPC)) %>%
  ungroup() %>%
  arrange(varNormGPC) %>%
  top_n(10 * length(unique(gapminder$year)))


# I learned how to use select to reshape my data from this article:
# https://datacarpentry.org/R-ecology-lesson/03-dplyr.html#reshaping_with_gather_and_spread
volatileGdpPerCapitaPretty = volatileGdpPerCapita %>%
  select(country, year, gdpPercap) %>%
  spread(key = year, value = gdpPercap)

volatileGdpPerCapitaTable = volatileGdpPerCapitaPretty %>%
  knitr::kable(digits = 2)
```

```{r volatileGdpPerCapitaPlot}
volatileGdpPerCapitaPlot = volatileGdpPerCapita %>%
  ggplot(aes(x = year, y = gdpPercap)) +
  geom_line(aes(group = country, colour = country)) +
  theme_bw()
```

<div class="twoC">
```{r volatileGdpPerCapitaGraphics = 'asis', fig.width=10, echo = FALSE}
volatileGdpPerCapitaTable
volatileGdpPerCapitaPlot
```
</div>
<div class="clearer"></div>

There are several interesting stories in this data, especially considering that these are the ten countries with the greatest variance in gdpPerCapita relative to the continent means. The most obvious interesting story is Kuwait, which swings between high GPC's (GDP per capita) until the 1970's before dropping from `r volatileGdpPerCapita %>% filter(year == 1952, country == "Kuwait") %>% select(gdpPercap)` to `r volatileGdpPerCapita %>% filter(year == 1987, country == "Kuwait") %>% select(gdpPercap)`, before beginning to gradually rise. This is likely due to the fact that Kuwait's wealth derives from oil reserves, which depend upon international oil prices. I believe this is especially interesting given that the fall occurred before the Gulf War, in which Kuwait was invaded by Iraq.

There are several countries that had success followed by a decline, such as Libya, Saudi Arabia, and Gabon. The first two of these also have economies that largely depend on oil. The last, Gabon, simply had an unfortunately stagnant economy.

Thankfully, there are many more countries that are success stories. Their variance will have been inflated by the fact that their economies were not volatile, but rather grown much faster than the rest of the region. Some examples of this are Hong Kong, Mauritius, and Taiwan. Though I never intended to include countries with uniform success, I believe that they are still interesting due to their degree of success. It is also nice to see some success amongst the tumult of the other, more volatile, economies.